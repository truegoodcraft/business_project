<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Core Dashboard</title>
    <link rel="stylesheet" href="/ui/static/styles.css" />
  </head>
  <body>
    <header class="page-header">
      <div class="header-main">
        <h1>Core Dashboard</h1>
        <button id="refresh-all" type="button">Refresh All</button>
      </div>
      <div class="token-controls">
        <label for="token-input">Session Token</label>
        <input type="password" id="token-input" autocomplete="off" />
        <button id="save-token" type="button">Save Token</button>
      </div>
    </header>

    <div
      class="muted"
      style="margin:0 clamp(1rem, 3vw, 2.5rem);padding:0.75rem 1rem;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:rgba(0,0,0,0.04);font-size:0.95rem;line-height:1.5;"
    >
      Local &amp; Transparent: data never leaves your machine. HTTP is localhost-only. Telemetry is off.
      <br />
      Licenses — Core:
      <a href="https://polyformproject.org/licenses/noncommercial/1.0.0/" target="_blank"
        >PolyForm-Noncommercial-1.0.0</a
      >;
      Plugins (default):
      <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache-2.0</a>.
    </div>

    <div class="banner error hidden" id="token-banner">Invalid or missing token</div>

    <nav class="tab-bar">
      <button id="tab-btn-dashboard" class="tab-button active" type="button">Dashboard</button>
      <button id="tab-btn-tools" class="tab-button" type="button">Tools</button>
      <button id="tab-btn-settings" class="tab-button" type="button">Settings</button>
    </nav>

    <section id="tab-dashboard" class="tab-section">
      <div class="panels">
        <div class="panel">
          <div class="panel-header"><span>Health</span></div>
          <div class="panel-body" id="health-body">
            <div>
              <strong>Google Drive</strong>:
              <span id="health-drive-status" class="muted">Checking…</span>
              <button id="btn-drive-disconnect" class="btn btn-secondary" style="margin-left:8px;">
                Disconnect
              </button>
            </div>
            <div style="margin-top:8px;">
              <strong>Server</strong>:
              <span>Running</span>
              <button id="btn-server-restart" class="btn btn-secondary" style="margin-left:8px;">
                Reboot?
              </button>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header"><span>Capabilities</span></div>
          <div class="panel-body">
            <input
              id="cap-filter"
              placeholder="Filter by plugin or ability…"
              style="width:100%;margin-bottom:6px;"
            />
            <div id="cap-list" class="list"></div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header"><span>Plugins</span></div>
          <div class="panel-body">
            <input
              id="plugin-filter"
              placeholder="Filter plugins…"
              style="width:100%;margin-bottom:6px;"
            />
            <div id="plugin-list" class="list"></div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <span>Explorer</span>
          </div>
          <div class="panel-body">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap;">
              <button id="expl-back" class="btn btn-secondary" title="Back">←</button>
              <span id="expl-breadcrumb" class="muted">Explorer</span>
              <span style="flex:1;"></span>
              <input
                id="expl-search"
                placeholder="Search…"
                style="flex:1;min-width:160px;max-width:320px;"
              />
              <button id="expl-refresh" class="btn">Refresh</button>
            </div>
            <div id="expl-list" class="list" style="min-height:220px;"></div>
            <div id="expl-log" class="log"></div>
          </div>
        </div>
      </div>

      <div class="panel logs">
        <div class="panel-header">
          <span>Logs</span>
          <div class="panel-actions">
            <label class="autoscale">
              <input type="checkbox" id="logs-autoscroll" /> Auto-scroll
            </label>
            <button id="logs-refresh" type="button">Refresh</button>
          </div>
        </div>
        <pre class="panel-content" id="logs-content"></pre>
      </div>
    </section>

    <section id="tab-tools" class="tab-section" style="display: none;">
      <div class="panel" style="display:flex;gap:16px;flex-wrap:wrap;">
        <div style="min-width:200px;width:220px;">
          <div class="panel-header"><span>Tools</span></div>
          <div class="panel-body" id="tools-nav" style="min-height:200px;"></div>
        </div>
        <div style="flex:1;min-width:260px;">
          <div class="panel-header"><span>Tool Detail</span></div>
          <div class="panel-body" id="tools-content" style="min-height:260px;"></div>
        </div>
      </div>
    </section>

    <section id="tab-settings" class="tab-section" style="display: none;">
      <div class="panels settings-panels">
        <section class="panel settings-card">
          <div class="settings-card-header">
            <div>
              <h2>Integrations</h2>
              <p class="settings-subtitle">Google Drive (Read-only)</p>
            </div>
            <span id="gs-status" class="status-pill bad">Not configured</span>
          </div>
          <div class="form-field">
            <label for="gs-client-id">Client ID</label>
            <input id="gs-client-id" type="text" autocomplete="off" />
            <small class="field-note">Shown masked on load; leave blank to keep existing.</small>
          </div>
          <div class="form-field">
            <label for="gs-client-secret">Client Secret</label>
            <input id="gs-client-secret" type="password" autocomplete="off" />
            <small class="field-note">Shown masked on load; leave blank to keep existing.</small>
          </div>
          <div class="settings-actions">
            <button id="gs-save" class="btn" type="button">Save</button>
            <button id="gs-test" class="btn" type="button">Test Connection</button>
            <button id="gs-remove" class="btn btn-danger" type="button">Remove / Disconnect</button>
          </div>
        </section>
        <section class="panel settings-card">
          <div class="panel-header">
            <span>Reader – Drive Scope</span>
          </div>
          <div class="panel-body">
            <label><input type="checkbox" id="di-my" checked /> Include My Drive</label>
            <div style="margin:6px 0;">
              <button id="di-pick-root" class="btn btn-secondary" type="button">
                Select My Drive root folder…
              </button>
              <span id="di-root-label" class="muted">Root: actual My Drive root</span>
            </div>
            <label><input type="checkbox" id="di-shared" checked /> Include Shared Drives</label>
            <div id="di-shared-list" style="margin-top:6px;"></div>
            <div style="margin-top:10px;">
              <button id="di-save" class="btn" type="button">Save Drive Scope</button>
            </div>
          </div>
        </section>
        <div class="panel">
          <div class="panel-header"><span>Settings — Local Sources</span></div>
          <div class="panel-body">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <button id="ls-scan" class="btn">Scan Drives</button>
              <input
                id="ls-folder"
                placeholder="Add folder path (e.g. C:\Data)"
                style="flex:1;"
              />
              <button id="ls-validate" class="btn btn-secondary">Validate</button>
              <button id="ls-add" class="btn">Add</button>
              <span id="ls-msg" class="muted"></span>
            </div>
            <div style="display:flex; gap:16px; margin-top:10px; flex-wrap:wrap;">
              <div style="min-width:260px;">
                <div class="muted" style="margin-bottom:6px;">Available drives</div>
                <div id="ls-drives" class="list"></div>
              </div>
              <div style="min-width:320px; flex:1;">
                <div class="muted" style="margin-bottom:6px;">Selected roots (allow-list)</div>
                <div id="ls-selected" class="list"></div>
                <div style="margin-top:8px;">
                  <button id="ls-save" class="btn">Save</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div style="margin-top:16px; padding:12px; border:1px solid #333; border-radius:6px;">
          <h3 style="margin:0 0 8px 0;">Safety</h3>
          <div style="display:flex; align-items:center; gap:12px;">
            <div id="writesStatus">Writes: <strong>Loading…</strong></div>
            <label>
              <input id="writesToggle" type="checkbox" />
              Enable writes (dangerous)
            </label>
          </div>
          <div class="muted" style="margin-top:6px;">Env <code>BUS_ALLOW_LOCAL_WRITES=1</code> always forces ON.</div>
        </div>

        <div style="margin-top:16px; padding:12px; border:1px solid #333; border-radius:6px;">
          <h3 style="margin:0 0 8px 0;">Organizer (beta)</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <input
              id="orgStart"
              type="text"
              placeholder="Start folder (absolute path under allowed roots)"
              style="min-width:360px;padding:6px;"
            />
            <input
              id="orgQdir"
              type="text"
              placeholder="Quarantine dir (optional)"
              style="min-width:320px;padding:6px;"
            />
            <button id="btnDupPlan" type="button">Find Duplicates → Plan</button>
            <button id="btnRenPlan" type="button">Normalize Names → Plan</button>
          </div>
          <div id="orgOut" style="margin-top:8px; white-space:pre-wrap;"></div>
          <div class="muted" style="margin-top:6px;">After a plan is created, use Preview/Commit below.</div>
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            <input
              id="orgPlanId"
              type="text"
              placeholder="Plan ID"
              style="min-width:300px;padding:6px;"
            />
            <button id="btnPrev" type="button">Preview</button>
            <button id="btnCommit" type="button">Commit</button>
          </div>
        </div>

        <div style="margin-top:16px; padding:12px; border:1px solid #333; border-radius:6px;">
          <h3 style="margin:0 0 8px 0;">Dev Tools</h3>
          <button id="btnPingPlugin" type="button">Ping Plugin</button>
          <pre id="pingOut" style="margin-top:8px; white-space:pre-wrap;"></pre>
        </div>
      </div>
    </section>

    <script>
(function(){
  // --- Session token discovery (robust) ---
  function discoverToken(){
    // 1) Known globals set by the app
    if (window.__SESSION_TOKEN) return String(window.__SESSION_TOKEN);
    if (window.__sessionToken)  return String(window.__sessionToken);
    if (window.BUS_SESSION_TOKEN) return String(window.BUS_SESSION_TOKEN);

    // 2) Common localStorage keys used by the app
    const lsKeys = [
      "session_token","bus.session_token","BUS_SESSION_TOKEN",
      "tgc_session_token","tgc.session_token"
    ];
    for (const k of lsKeys){
      try { const v = localStorage.getItem(k); if (v) return String(v); } catch(_) {}
    }

    // 3) UI input field (top-right “Session Token”)
    const candidates = Array.from(document.querySelectorAll('input[type="password"],input[type="text"]'));
    for (const el of candidates){
      const id = (el.id||"").toLowerCase();
      const name = (el.name||"").toLowerCase();
      const ph = (el.placeholder||"").toLowerCase();
      if (id.includes("session") || name.includes("session") || ph.includes("session token")){
        if (el.value) return String(el.value);
      }
    }
    return "";
  }
  function headers(){
    const t = discoverToken();
    const h = {"Content-Type":"application/json"};
    if (t) h["X-Session-Token"] = t;
    return h;
  }

  // --- Writes status/toggle ---
  async function refreshWrites(){
    try{
      const r = await fetch("/dev/writes",{headers: headers()});
      const j = await r.json();
      const on = !!j.enabled;
      document.getElementById("writesToggle").checked = on;
      document.getElementById("writesStatus").innerHTML =
        "Writes: <strong>"+(on?"Enabled":"Disabled")+"</strong>";
    }catch(e){
      document.getElementById("writesStatus").textContent = "Writes: error";
    }
  }

  const toggle = document.getElementById("writesToggle");
  const statusEl = document.getElementById("writesStatus");
  let saving = false;

  toggle.addEventListener("change", async (ev)=>{
    if (saving) return;
    const prev = !ev.target.checked;   // what it was before
    saving = true;
    toggle.disabled = true;
    try{
      const r = await fetch("/dev/writes",{
        method:"POST",
        headers: headers(),
        body: JSON.stringify({enabled: ev.target.checked})
      });
      if (!r.ok){
        const j = await r.json().catch(()=>({detail:r.statusText}));
        throw new Error(j.detail || `HTTP ${r.status}`);
      }
      await refreshWrites();
    }catch(err){
      // Revert UI and show message
      ev.target.checked = prev;
      statusEl.innerHTML = `Writes: <strong>${prev?"Disabled":"Enabled"}</strong> <span class="err" style="color:#c33;margin-left:8px;">(${String(err).replace("Error: ","")})</span>`;
    }finally{
      saving = false;
      toggle.disabled = false;
    }
  });

  // --- Organizer (beta) ---
  const orgStart = document.getElementById("orgStart");
  const orgQdir = document.getElementById("orgQdir");
  const orgOut = document.getElementById("orgOut");
  const orgPlan = document.getElementById("orgPlanId");
  const btnDup = document.getElementById("btnDupPlan");
  const btnRen = document.getElementById("btnRenPlan");
  const btnPrev = document.getElementById("btnPrev");
  const btnCommit = document.getElementById("btnCommit");

  function orgSetOut(value){
    if (!orgOut) return;
    if (typeof value === "string"){
      orgOut.textContent = value;
    } else {
      try{
        orgOut.textContent = JSON.stringify(value,null,2);
      }catch(err){
        orgOut.textContent = String(value);
      }
    }
  }

  async function orgPost(url, body){
    const response = await fetch(url, {
      method: "POST",
      headers: headers(),
      body: JSON.stringify(body || {}),
    });
    const text = await response.text();
    let parsed;
    try{
      parsed = text ? JSON.parse(text) : {};
    }catch(err){
      parsed = {error: String(err), raw: text};
    }
    if (!response.ok){
      const detail = parsed && typeof parsed === "object" ? (parsed.detail || parsed.error) : undefined;
      throw new Error(detail || `HTTP ${response.status}`);
    }
    return parsed;
  }

  if (orgStart && orgOut && btnDup && btnRen && btnPrev && btnCommit){
    btnDup.addEventListener("click", async ()=>{
      if (!orgStart.value.trim()){
        alert("Provide a start folder under allowed roots.");
        return;
      }
      orgSetOut("Scanning for duplicates…");
      try{
        const payload = await orgPost("/organizer/duplicates/plan", {
          start_path: orgStart.value.trim(),
          quarantine_dir: orgQdir ? (orgQdir.value.trim() || null) : null,
        });
        if (orgPlan) orgPlan.value = payload.plan_id || "";
        orgSetOut(payload);
      }catch(err){
        orgSetOut({error: String(err)});
      }
    });

    btnRen.addEventListener("click", async ()=>{
      if (!orgStart.value.trim()){
        alert("Provide a start folder under allowed roots.");
        return;
      }
      orgSetOut("Scanning filenames…");
      try{
        const payload = await orgPost("/organizer/rename/plan", {
          start_path: orgStart.value.trim(),
        });
        if (orgPlan) orgPlan.value = payload.plan_id || "";
        orgSetOut(payload);
      }catch(err){
        orgSetOut({error: String(err)});
      }
    });

    btnPrev.addEventListener("click", async ()=>{
      if (!orgPlan || !orgPlan.value.trim()){
        alert("No plan id");
        return;
      }
      orgSetOut("Loading preview…");
      try{
        const payload = await orgPost(`/plans/${encodeURIComponent(orgPlan.value.trim())}/preview`, {});
        orgSetOut(payload);
      }catch(err){
        orgSetOut({error: String(err)});
      }
    });

    btnCommit.addEventListener("click", async ()=>{
      if (!orgPlan || !orgPlan.value.trim()){
        alert("No plan id");
        return;
      }
      orgSetOut("Committing plan…");
      try{
        const payload = await orgPost(`/plans/${encodeURIComponent(orgPlan.value.trim())}/commit`, {});
        orgSetOut(payload);
      }catch(err){
        orgSetOut({error: String(err)});
      }
    });
  }

  // --- Dev: Ping Plugin ---
  const pingBtn = document.getElementById("btnPingPlugin");
  if (pingBtn){
    pingBtn.addEventListener("click", async ()=>{
      const out = document.getElementById("pingOut");
      out.textContent = "Pinging…";
      try{
        const r = await fetch("/dev/ping_plugin",{headers: headers()});
        const j = await r.json();
        out.textContent = JSON.stringify(j,null,2);
      }catch(e){
        out.textContent = JSON.stringify({error:String(e)},null,2);
      }
    });
  }

  // Initial load
  refreshWrites();
})();
    </script>
    <script src="/ui/static/app.js" defer></script>
  </body>
</html>
