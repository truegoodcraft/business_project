<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BUS Core — FixKit</title>
<style>
  :root { --bg:#0b0b0c; --fg:#e8e8ea; --muted:#9aa; --card:#141417; --accent:#6ea8fe; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,Segoe UI,Roboto}
  a{color:var(--accent);text-decoration:none}
  .wrap{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
  aside{background:#0f0f12;border-right:1px solid #222;padding:16px;position:sticky;top:0;height:100vh}
  main{padding:16px}
  h1{font-size:18px;margin:0 0 12px}
  .nav a{display:block;padding:8px 10px;border-radius:8px;margin-bottom:4px;color:var(--fg)}
  .nav a.active{background:#1b1b20}
  .card{background:var(--card);border:1px solid #222;border-radius:12px;padding:12px;margin-bottom:12px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  button{background:#1f1f25;border:1px solid #2a2a32;border-radius:8px;color:#fff;padding:8px 12px;cursor:pointer}
  input{background:#101015;border:1px solid #26262e;border-radius:8px;color:#fff;padding:8px;width:100%}
</style>
<!-- BEGIN ui-scripts -->
<link rel="preload" href="/ui/js/token.js?v={{version}}" as="script">
<link rel="preload" href="/ui/js/api.js?v={{version}}" as="script">
<script src="/ui/js/token.js?v={{version}}" defer></script>
<script src="/ui/js/api.js?v={{version}}" defer></script>
<script>
  // Route bootstrap waits for token
  window.addEventListener('bus:token-ready', function(){
    if (!location.hash) location.hash = '#/writes';
    window.dispatchEvent(new HashChangeEvent('hashchange'));
  });
</script>
<!-- END ui-scripts -->
<div class="wrap">
  <aside>
    <h1>BUS Core</h1>
    <div class="muted" id="license">Local-only. Token loading…</div>
    <div class="nav">
      <a id="nav-writes"    href="#/writes">Writes</a>
      <a id="nav-organizer" href="#/organizer">Organizer</a>
      <a id="nav-dev"       href="#/dev">Dev</a>
    </div>
  </aside>
  <main><div id="view"></div></main>
</div>
<script src="/ui/js/cards/writes.js?v={{version}}" defer></script>
<script src="/ui/js/cards/organizer.js?v={{version}}" defer></script>
<script src="/ui/js/cards/dev.js?v={{version}}" defer></script>
<script>
  (function(){
    const TOKEN_KEY = 'BUS_SESSION_TOKEN';
    window.busCards = window.busCards || {};

    const routes = {
      '/writes':    () => window.busCards.mountWrites,
      '/organizer': () => window.busCards.mountOrganizer,
      '/dev':       () => window.busCards.mountDev,
    };

    function currentRoute() {
      const h = location.hash || '#/writes';
      const key = h.startsWith('#') ? h.slice(1) : h;
      return routes[key] ? key : '/writes';
    }

    function setActive(hash) {
      document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
      const id = 'nav-' + (hash.replace('#/','') || 'writes');
      const el = document.getElementById(id);
      if (el) el.classList.add('active');
    }

    async function render() {
      const view = document.getElementById('view');
      if (!view) return;
      const key = currentRoute();
      const resolver = routes[key] || routes['/writes'];
      const mount = resolver ? resolver() : null;
      view.innerHTML = '';
      const card = document.createElement('div');
      card.className = 'card';
      view.appendChild(card);
      setActive('#' + key);
      if (typeof mount !== 'function') {
        card.textContent = 'Loading…';
        return;
      }
      try {
        await Promise.resolve(mount(card));
      } catch (error) {
        card.textContent = 'Error: ' + (error && error.message ? error.message : error);
      }
    }

    async function updateLicense(){
      if (typeof window.apiGet !== 'function') return;
      try {
        const info = await window.apiGet('/health');
        const lic = document.getElementById('license');
        if (lic) {
          const tok = localStorage.getItem(TOKEN_KEY) || '';
          const pfx = tok ? tok.slice(0,6) + '…' : '—';
          lic.textContent = `Local-only · Core: ${info?.licenses?.core?.name || '—'} · v ${info?.version || '—'} · token ${pfx}`;
        }
      } catch (error) {
        console.warn('health fetch failed', error);
      }
    }

    window.addEventListener('hashchange', render);
    window.addEventListener('bus:token-ready', () => {
      updateLicense().finally(() => {
        render();
        setTimeout(render, 0);
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      updateLicense().finally(render);
    });
  })();
</script>
