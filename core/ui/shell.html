<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>BUS Core â€” Local Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="js/token.js" defer></script>
  <script src="js/api.js" defer></script>
</head>
<body>
  <nav class="sidebar">
    <h1>BUS Core</h1>
    <ul>
      <li><a href="#writes">Writes</a></li>
      <li><a href="#organizer">Organizer</a></li>
      <li><a href="#dev">Dev</a></li>
    </ul>
  </nav>
  <main>
    <details id="writes">
      <summary>Writes</summary>
      <div id="writes-card">Loading...</div>
    </details>
    <details id="organizer">
      <summary>Organizer</summary>
      <div id="organizer-card">Loading...</div>
    </details>
    <details id="dev">
      <summary>Dev</summary>
      <div id="dev-card">Loading...</div>
    </details>
  </main>
  <script>
    document.addEventListener('bus:token-ready',async()=>{
      console.log('Loading cards...');
      const writesCard=document.getElementById('writes-card');
      writesCard.innerHTML='<label>Writes: <input type="checkbox" id="writes-toggle"></label><pre id="writes-out"></pre>';
      const toggle=document.getElementById('writes-toggle');
      const out=document.getElementById('writes-out');
      async function refreshWrites(){
        try{
          const data=await apiCall('/dev/writes');
          toggle.checked=data.enabled;
          out.textContent=JSON.stringify(data,null,2);
        }catch(e){
          out.textContent='Error: '+e.message;
        }
      }
      toggle.addEventListener('change',async()=>{
        try{
          const data=await post('/dev/writes',{enabled:toggle.checked});
          out.textContent=JSON.stringify(data,null,2);
          await refreshWrites();
        }catch(e){
          out.textContent='Error: '+e.message;
        }
      });
      await refreshWrites();
      const organizerCard=document.getElementById('organizer-card');
      organizerCard.innerHTML='<input id="start-path" placeholder="Folder path"><button id="scan-dupes">Scan Dupes</button><pre id="org-out"></pre>';
      document.getElementById('scan-dupes').addEventListener('click',async()=>{
        try{
          const path=document.getElementById('start-path').value;
          const data=await post('/organizer/duplicates/plan',{start_path:path});
          document.getElementById('org-out').textContent=JSON.stringify(data,null,2);
        }catch(e){
          document.getElementById('org-out').textContent='Error: '+e.message;
        }
      });
      const devCard=document.getElementById('dev-card');
      devCard.innerHTML='<button id="ping-btn">Ping Plugin</button><pre id="dev-out"></pre>';
      document.getElementById('ping-btn').addEventListener('click',async()=>{
        try{
          const data=await apiCall('/dev/ping_plugin');
          document.getElementById('dev-out').textContent=JSON.stringify(data,null,2);
        }catch(e){
          document.getElementById('dev-out').textContent='Error: '+e.message;
        }
      });
    });
  </script>
</body>
</html>
