<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>BUS Core â€” Local Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="js/token.js" defer></script>
</head>
<body>
  <nav class="sidebar">
    <h1>BUS Core</h1>
    <ul>
      <li><a href="#writes">Writes</a></li>
      <li><a href="#organizer">Organizer</a></li>
      <li><a href="#dev">Dev</a></li>
    </ul>
  </nav>
  <main>
    <details id="writes">
      <summary>Writes</summary>
      <div id="writes-card">Loading...</div>
    </details>
    <details id="organizer">
      <summary>Organizer</summary>
      <div id="organizer-card">Loading...</div>
    </details>
    <details id="dev">
      <summary>Dev</summary>
      <div id="dev-card">Loading...</div>
    </details>
  </main>
  <script type="module">
    import { mountWrites } from './js/cards/writes.js';
    import { mountOrganizer } from './js/cards/organizer.js';
    import { mountDev } from './js/cards/dev.js';

    async function refreshCard(mountFn,id){
      const root=document.getElementById(id);
      if(!root) return;
      try{
        await mountFn(root);
      }catch(error){
        console.error(`${id} failed to load:`,error);
        root.textContent='Error: '+error.message;
      }
    }

    async function refreshAllCards(){
      await Promise.all([
        refreshCard(mountWrites,'writes-card'),
        refreshCard(mountOrganizer,'organizer-card'),
        refreshCard(mountDev,'dev-card')
      ]);
    }

    async function handleTokenReady(){
      try{
        await refreshAllCards();
      }catch(error){
        console.error('Card refresh failed:',error);
      }
    }

    document.addEventListener('bus:token-ready',()=>{ handleTokenReady(); });

    if(localStorage.getItem('tgc_token')){
      handleTokenReady();
    }
  </script>
</body>
</html>
