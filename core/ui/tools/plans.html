<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>BUS Core â€” Plans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .row { display: flex; gap: 8px; align-items: center; margin: 6px 0; }
    input[type=text], select { padding: 6px; min-width: 280px; }
    button { padding: 6px 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 12px; }
    .muted { color: #666; font-size: 12px; }
    .ok { color: green; }
    .err { color: #b00; }
  </style>
</head>
<body>
  <h2>Plans</h2>
  <div class="muted">Create a plan, add actions (local paths for now), preview, then commit (requires BUS_ALLOW_LOCAL_WRITES=1).</div>

  <h3>Create Plan</h3>
  <div class="row">
    <label>Plan ID <input id="planId" type="text" placeholder="plan-001"></label>
    <label>Title <input id="planTitle" type="text" placeholder="My reorg"></label>
    <label>Note <input id="planNote" type="text" placeholder="Optional note"></label>
    <button id="createPlan">Create</button>
  </div>

  <h3>Actions</h3>
  <div id="actions"></div>
  <div class="row">
    <select id="kind">
      <option value="move">MOVE</option>
      <option value="rename">RENAME</option>
      <option value="copy">COPY</option>
      <option value="delete">DELETE</option>
      <option value="hardlink">HARDLINK</option>
    </select>
    <input id="srcPath" type="text" placeholder="src_path (abs path)">
    <input id="dstParent" type="text" placeholder="dst_parent_path OR leave blank if dst_path set">
    <input id="dstName" type="text" placeholder="dst_name (optional)">
    <input id="dstPath" type="text" placeholder="dst_path (optional)">
    <button id="addAction">Add</button>
    <button id="savePlan">Save Plan</button>
  </div>

  <h3>Preview & Commit</h3>
  <div class="row">
    <button id="preview">Preview</button>
    <button id="commit">Commit</button>
    <span id="commitHint" class="muted">(requires BUS_ALLOW_LOCAL_WRITES=1)</span>
  </div>

  <div id="previewOut"></div>
  <h3>Existing Plans</h3>
  <div id="plansTable"></div>

<script>
(function () {
  const token = (window.__SESSION_TOKEN || window.__sessionToken || window.BUS_SESSION_TOKEN || "").toString();
  function headers() {
    const h = {"Content-Type":"application/json"};
    if (token) h["X-Session-Token"] = token;
    return h;
  }
  const el = (id)=>document.getElementById(id);
  let actions = [];
  function renderActions() {
    const rows = actions.map(a => 
      `<tr><td>${a.id}</td><td>${a.kind}</td><td>${a.meta.src_path||""}</td><td>${a.meta.dst_parent_path||""}</td><td>${a.meta.dst_name||""}</td><td>${a.meta.dst_path||""}</td></tr>`
    ).join("");
    el("actions").innerHTML = `
      <table>
        <thead><tr><th>id</th><th>kind</th><th>src_path</th><th>dst_parent_path</th><th>dst_name</th><th>dst_path</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  }
  function planBody() {
    return {
      id: el("planId").value.trim(),
      source: "ui",
      title: el("planTitle").value.trim() || "Untitled",
      note: el("planNote").value.trim() || null,
      actions: actions,
      status: "draft",
      stats: {}
    };
  }
  async function refreshPlans() {
    const r = await fetch("/plans", {headers: headers()});
    const list = await r.json();
    const rows = list.map(p => `<tr>
      <td>${p.id}</td><td>${p.title}</td><td>${p.status}</td>
      <td><button data-id="${p.id}" class="btn-load">Load</button></td>
    </tr>`).join("");
    el("plansTable").innerHTML = `<table><thead><tr><th>id</th><th>title</th><th>status</th><th>open</th></tr></thead><tbody>${rows}</tbody></table>`;
    document.querySelectorAll(".btn-load").forEach(b => b.onclick = async () => {
      const id = b.getAttribute("data-id");
      const rr = await fetch("/plans/"+encodeURIComponent(id), {headers: headers()});
      const plan = await rr.json();
      el("planId").value = plan.id;
      el("planTitle").value = plan.title;
      el("planNote").value = plan.note || "";
      actions = plan.actions || [];
      renderActions();
    });
  }

  el("addAction").onclick = () => {
    const id = `${Date.now()}-${Math.random().toString(16).slice(2,6)}`;
    actions.push({
      id, kind: el("kind").value,
      meta: {
        src_path: el("srcPath").value.trim() || null,
        dst_parent_path: el("dstParent").value.trim() || null,
        dst_name: el("dstName").value.trim() || null,
        dst_path: el("dstPath").value.trim() || null
      }
    });
    renderActions();
  };

  el("savePlan").onclick = async () => {
    const body = planBody();
    if (!body.id) { alert("Plan ID is required"); return; }
    const r = await fetch("/plans", {method:"POST", headers: headers(), body: JSON.stringify(body)});
    if (!r.ok) { alert("Save failed"); return; }
    await refreshPlans();
    alert("Plan saved");
  };

  el("createPlan").onclick = () => { actions = []; renderActions(); };

  el("preview").onclick = async () => {
    const id = el("planId").value.trim();
    if (!id) { alert("Plan ID required"); return; }
    const r = await fetch(`/plans/${encodeURIComponent(id)}/preview`, {method:"POST", headers: headers()});
    const j = await r.json();
    el("previewOut").innerHTML = `<pre>${JSON.stringify(j, null, 2)}</pre>`;
  };

  el("commit").onclick = async () => {
    const id = el("planId").value.trim();
    if (!id) { alert("Plan ID required"); return; }
    const r = await fetch(`/plans/${encodeURIComponent(id)}/commit`, {method:"POST", headers: headers()});
    const j = await r.json();
    if (r.status === 403) {
      el("previewOut").innerHTML = `<div class="err">Commit blocked: ${j.detail || "forbidden"}.</div>`;
    } else {
      el("previewOut").innerHTML = `<pre>${JSON.stringify(j, null, 2)}</pre>`;
    }
    await refreshPlans();
  };

  renderActions();
  refreshPlans();
})();
</script>
</body>
</html>
